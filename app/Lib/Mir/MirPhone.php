<?php namespace App\Lib\Mir;

class MirPhone {

    // Twilio: 819011112222
    public static function to_8190($phone_no): string
    {
        $stripped = MirPhone::_strip($phone_no);

        if (empty($stripped)) {
            return '';
        }

        return "81{$stripped}";
    }

    // Faximo: 09011112222
    public static function to_090($phone_no)
    {
        $stripped = MirPhone::_strip($phone_no);

        if (empty($stripped)) {
            return '';
        }

        return "0{$stripped}";
    }

    // Human: 090-1111-2222
    public static function to_human($phone_no): string
    {
        $stripped = MirPhone::_strip($phone_no);

        if (empty($stripped)) {
            return '';
        }

        if ($stripped == 'n/a') {
            return 'n/a';
        }

        list($p1, $p2) = MirPhone::split_pos($stripped);

        $n1 = substr($stripped, 0, $p1);
        $n2 = substr($stripped, $p1, $p2);
        $n3 = substr($stripped, $p1 + $p2);

        $human_phone_no = "0{$n1}-{$n2}-{$n3}";
        return $human_phone_no;
    }

    // 9011112222
    public static function _strip($phone_no): string
    {
        $tmp = $phone_no ?? '';
        $tmp = mb_convert_kana($tmp, 'as');
        $tmp = preg_replace("/[^0-9]/", '', $tmp);
        $tmp = preg_replace("/^81/", '', $tmp);
        $tmp = preg_replace("/^0/", '', $tmp);

        if (! preg_match("/\A[0-9]{9,10}\z/", $tmp)) {
            return '';
        }

        return $tmp;
    }

    // 電話番号から、市外局番の桁数と、市内局番の桁数を返す
    public static function split_pos($phone_no): array
    {
        $separate_pos = MirPhone::separate_pos();
        for ($i = 4; $i > 0; $i--) {
            $sample = substr($phone_no, 0, $i);
            $len = $separate_pos[$i][$sample] ?? 0;
            if ($len > 0) {
                return [$i, $len];
            }
        }
        return [4, 2];
    }

    // 市外局番の一覧
    // https://www.soumu.go.jp/main_sosiki/joho_tsusin/top/tel_number/shigai_list.html
    private static function separate_pos(): array
    {
        // 1267 = 01267-C-1111
        return [
            // 4文字マッチ
            4 => [
                '1267' => 1,
                '1372' => 1,
                '1374' => 1,
                '1377' => 1,
                '1392' => 1,
                '1397' => 1,
                '1398' => 1,
                '1456' => 1,
                '1457' => 1,
                '1466' => 1,
                '1547' => 1,
                '1558' => 1,
                '1564' => 1,
                '1586' => 1,
                '1587' => 1,
                '1632' => 1,
                '1634' => 1,
                '1635' => 1,
                '1648' => 1,
                '1654' => 1,
                '1655' => 1,
                '1656' => 1,
                '1658' => 1,
                '4992' => 1,
                '4994' => 1,
                '4996' => 1,
                '4998' => 1,
                '5769' => 1,
                '5979' => 1,
                '7468' => 1,
            ],
            // 3文字マッチ
            3 => [
                '600' => 3,
                '800' => 3,
                '123' => 2,
                '124' => 2,
                '125' => 2,
                '126' => 2,
                '133' => 2,
                '134' => 2,
                '135' => 2,
                '136' => 2,
                '137' => 2,
                '138' => 2,
                '139' => 2,
                '142' => 2,
                '143' => 2,
                '144' => 2,
                '145' => 2,
                '146' => 2,
                '152' => 2,
                '153' => 2,
                '154' => 2,
                '155' => 2,
                '156' => 2,
                '157' => 2,
                '158' => 2,
                '162' => 2,
                '163' => 2,
                '164' => 2,
                '165' => 2,
                '166' => 2,
                '167' => 2,
                '172' => 2,
                '173' => 2,
                '174' => 2,
                '175' => 2,
                '176' => 2,
                '178' => 2,
                '179' => 2,
                '182' => 2,
                '183' => 2,
                '184' => 2,
                '185' => 2,
                '186' => 2,
                '187' => 2,
                '191' => 2,
                '192' => 2,
                '193' => 2,
                '194' => 2,
                '195' => 2,
                '197' => 2,
                '198' => 2,
                '220' => 2,
                '223' => 2,
                '224' => 2,
                '225' => 2,
                '226' => 2,
                '228' => 2,
                '229' => 2,
                '233' => 2,
                '234' => 2,
                '235' => 2,
                '237' => 2,
                '238' => 2,
                '240' => 2,
                '241' => 2,
                '242' => 2,
                '243' => 2,
                '244' => 2,
                '246' => 2,
                '247' => 2,
                '248' => 2,
                '250' => 2,
                '254' => 2,
                '255' => 2,
                '256' => 2,
                '257' => 2,
                '258' => 2,
                '259' => 2,
                '260' => 2,
                '261' => 2,
                '263' => 2,
                '264' => 2,
                '265' => 2,
                '266' => 2,
                '267' => 2,
                '268' => 2,
                '269' => 2,
                '270' => 2,
                '274' => 2,
                '276' => 2,
                '277' => 2,
                '278' => 2,
                '279' => 2,
                '280' => 2,
                '282' => 2,
                '283' => 2,
                '284' => 2,
                '285' => 2,
                '287' => 2,
                '288' => 2,
                '289' => 2,
                '291' => 2,
                '293' => 2,
                '294' => 2,
                '295' => 2,
                '296' => 2,
                '297' => 2,
                '299' => 2,
                '422' => 2,
                '428' => 2,
                '436' => 2,
                '438' => 2,
                '439' => 2,
                '460' => 2,
                '463' => 2,
                '465' => 2,
                '466' => 2,
                '467' => 2,
                '470' => 2,
                '475' => 2,
                '476' => 2,
                '478' => 2,
                '479' => 2,
                '480' => 2,
                '493' => 2,
                '494' => 2,
                '495' => 2,
                '531' => 2,
                '532' => 2,
                '533' => 2,
                '536' => 2,
                '537' => 2,
                '538' => 2,
                '539' => 2,
                '544' => 2,
                '545' => 2,
                '547' => 2,
                '548' => 2,
                '550' => 2,
                '551' => 2,
                '553' => 2,
                '554' => 2,
                '555' => 2,
                '556' => 2,
                '557' => 2,
                '558' => 2,
                '561' => 2,
                '562' => 2,
                '563' => 2,
                '564' => 2,
                '565' => 2,
                '566' => 2,
                '567' => 2,
                '568' => 2,
                '569' => 2,
                '572' => 2,
                '573' => 2,
                '574' => 2,
                '575' => 2,
                '576' => 2,
                '577' => 2,
                '578' => 2,
                '581' => 2,
                '584' => 2,
                '585' => 2,
                '586' => 2,
                '587' => 2,
                '594' => 2,
                '595' => 2,
                '596' => 2,
                '597' => 2,
                '598' => 2,
                '599' => 2,
                '721' => 2,
                '725' => 2,
                '735' => 2,
                '736' => 2,
                '737' => 2,
                '738' => 2,
                '739' => 2,
                '740' => 2,
                '742' => 2,
                '743' => 2,
                '744' => 2,
                '745' => 2,
                '746' => 2,
                '747' => 2,
                '748' => 2,
                '749' => 2,
                '761' => 2,
                '763' => 2,
                '765' => 2,
                '766' => 2,
                '767' => 2,
                '768' => 2,
                '770' => 2,
                '771' => 2,
                '772' => 2,
                '773' => 2,
                '774' => 2,
            ],
            // 2文字マッチ
            2 => [
                '20' => 3,
                '50' => 4,
                '70' => 4,
                '80' => 4,
                '90' => 4,
                '11' => 3,
                '15' => 3,
                '17' => 3,
                '18' => 3,
                '19' => 3,
                '22' => 3,
                '23' => 3,
                '24' => 3,
                '25' => 3,
                '26' => 3,
                '27' => 3,
                '28' => 3,
                '29' => 3,
                '42' => 3,
                '43' => 3,
                '44' => 3,
                '45' => 3,
                '46' => 3,
                '47' => 3,
                '48' => 3,
                '49' => 3,
                '52' => 3,
                '53' => 3,
                '54' => 3,
                '55' => 3,
                '58' => 3,
                '59' => 3,
                '72' => 3,
                '73' => 3,
                '75' => 3,
                '76' => 3,
            ],
            // 1文字マッチ
            1 => [
                '3' => 4,
                '4' => 4,
                '6' => 4,
            ],
        ];
    }



}
